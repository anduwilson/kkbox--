特征工程

一、msno: 用户id，加密String，编码成整型唯一编号（根据注册时间递增，同时衍生出订阅歌曲量特征）。
	理由：缩短字符，节省空间，另外lightGBM对非one-hot离散型特征的处理需要整型。订阅歌曲量可以作为用户活跃程度的特征，越活越续订概率越大。
	
二、song id，歌曲id，加密String，编码成整型唯一编号（根据订阅用户数递增，同时衍生出歌曲用户订阅量特征）。
	理由：缩短字符，节省空间，另外lightGBM对非one-hot离散型特征的处理需要整型,也可以作为连续型特征，作为歌曲流行程度的排名。歌曲订阅量有可能与目标变量存在关系，如：越是热门的歌曲就越有可能被订阅。
	
三、source_system_tab（触发事件的类型/tab，用于表示app的功能类型），source_screen_name（用户看到的布局的名字（name of the layout）），source_type（用户在app上播放音乐的入口的类型）
	类别少，可枚举。lightGBM整数编码，其他模型编码成one-hot。
	
四、song_length歌曲时长，单位由毫秒转为分钟。
	理由：歌长一般都在若干分钟，若用毫秒做为单位，波动太大，会导致模型不易训练，转成分钟后，数值和类别都变少，增强鲁棒性。
	
五、genre_ids: genre 类别. 可多选，用 “|“隔开（对用'|'或'&'或'/'隔开的可多选特征，按照'|'或'&'或'/'切割，然后展开成多行）。
	理由：用户可能对“genre1|genre2|genre3”不敢兴趣，而单独对genre1，genre2或genre3有兴趣，artist_name（歌手），composer（作曲）和lyricist（作词）等同理：
	+---------+-------------------+----------------+--------------+
    |genre_ids|        artist_name|        composer|      lyricist|
    +---------+-------------------+----------------+--------------+
    |      465|張信哲 (Jeff Chang)|            董貞|        何啟弘|
    |      444|          BLACKPINK|TEDDY&Bekuh BOOM|         TEDDY|
    |      465|              S.H.E|          湯小康|   徐世珍/乐海|
    |  864|578|           貴族精選|    Joe Hisaishi|Hayao Miyazaki|
    +---------+-------------------+---------------+---------------+
    explode成如下：
    +---------+-------------------+---------------+--------------+
    |genre_ids|        artist_name|       composer|      lyricist|
    +---------+-------------------+---------------+--------------+
    |      465|張信哲 (Jeff Chang)|           董貞|        何啟弘|
    |      444|          BLACKPINK|          TEDDY|         TEDDY|
    |      444|          BLACKPINK|     Bekuh BOOM|         TEDDY|
    |      465|              S.H.E|         湯小康|        徐世珍|
	|      465|              S.H.E|         湯小康|          乐海|
    |      864|           貴族精選|   Joe Hisaishi|Hayao Miyazaki|
    |      578|           貴族精選|   Joe Hisaishi|Hayao Miyazaki|
    +---------+-------------------+---------------+--------------+
	*注：1）上表TEDDY&Bekuh BOOM按照‘&’切割扩展成下表TEDDY和Bekuh BOOM 2行样本，能单独对TEDDY和Bekuh BOOM作曲的表达出某种兴趣；
	     2）上表徐世珍/乐海按照‘/’切割扩展成下表徐世珍和乐海 2行样本，能表达出单独对徐世珍和乐海作词的兴趣；
		 3）上表864|578按照‘|’切割扩展成下表864和578 2行样本，能表达出对864或578种类歌曲的兴趣，而不单单训练对864|578同时满足时的联系。
		 
六、city：城市（转数值编码，同时衍生出城市用户数特征）
	理由：缩短字符，节省空间，另外lightGBM对非one-hot离散型特征的处理需要整型。统计每个城市的用户数，便于将城市按照人数多少划分为某几大类，如一线，二线三四线等。
	
七、bd: 年龄。将异常（小于等于0或大于100）年龄置空，作为缺省值处理，其他作为正常填写的年龄。
	理由：听歌软件一般不会填写很详细的资料，或者资料乱填，将异常资料作为缺省值处理，可以资料完整性看出用户对产品的信赖程度。
	
八、gender：性别（只有男女和未知3种状态，one-hot编码），registered_via: 注册方式同样处理。

九、registration_init_time: 注册时间，格式为%Y%m%d和expiration_date: 到期时间，格式为 %Y%m%d，挖掘衍生出一下特征：
    reg_day（注册日）,reg_week（周几注册）,reg_week_ordinal（第几周注册）,reg_month（注册月份）,reg_quarter（注册季度）,reg_year（注册年份）,diff_months（注册和到期间隔月数）
	diff_dates（注册和到期间隔天数）,exp_day（到期日）,exp_week（周几到期）,exp_week_ordinal（第几周到期）,exp_month（到期月份）,exp_quarter（到期季度）,exp_year（到期年份）
	理由：用户是否续约可能跟年份，月份，季度，周几以及是否工作日以及使用时长（注册和到期间隔）等有关，，先挖掘出来，是否与应变量相关由模型计算。
	
十、song name ：歌曲名字（TD-IDF和Word2Vec）
	理由：歌曲名称句子很长，用户对某些词比较敏感，可以通过文本分析出来。此外TD-IDF得到一个非常稀疏的矩阵，所以通过Word2Vec向量化成固定K维的向量。如下：

+--------------------------------------------+---------------------------------+-------------------------------------+------------------------------------------------------+-----------------------------------+
|song_id                                     |name（歌曲名字）                 |raw（分词）                          |words(去掉停用词)         |result(Word2Vec训练成K维向量)                                  |
+--------------------------------------------+---------------------------------+-------------------------------------+------------------------------------------------------+-----------------------------------+
|LP7pLJoJFBvyuUwvu+oLzjT+bI+UeBPURCecJsX1jjs=|我們                             |[我, 們]                             |[我, 們]                  |[-1.733993411064148,1.0893775522708893,-0.10691913217306137]   |
|ClazTFnk6r0Bnuie44bocdNMM3rdlrq0bCGAsGUWcHE=|Let Me Love You                  |[let, me, love, you]                 |[let, love]               |[0.27101588249206543,-0.1879812330007553,-0.6865866780281067]  |
|u2ja/bZE3zhCGxvbbOB3zOoUjx27u40cf5g09UXMoKQ=|原諒我                           |[我, 原, 諒]                         |[我, 原, 諒]              |[-1.5581705967585244,1.0155117313067117,-0.19311377902825672]  |
|92Fqsy0+p6+RHe2EoLKjHahORHR1Kq1TBJoClW9v+Ts=|Classic                          |[classic]                            |[classic]                 |[0.4156397581100464,-0.3099019229412079,0.2797485291957855]    |
|0QFmz/+rJy1Q56C1DuYqT9hKKqi5TUqx0sN0IwvoHrw=|愛投羅網                         |[網, 愛, 投, 羅]                     |[網, 愛, 投, 羅]          |[-1.2751358151435852,0.9243243038654327,0.020665927149821073]  |
|QU8f6JR0/cwLGSqJX2XDVzFK0DxMaIUY15ALJXK7ziw=|Our Time                         |[time, our]                          |[time]                    |[0.3939984142780304,-0.31165504455566406,-0.6470947265625]     |
|O1Oj4CmnZhbHl7oyBaHSpGeu5gvcSmUydY3Awmv3uxk=|癢                               |[癢]                                 |[癢]                      |[-0.4655384421348572,0.2347947210073471,0.08457393944263458]   |
|ie9l12ZYXEaP4evrBBUvnNnZGdupHSX5NU+tEqB1SDg=|每天愛你多一些                   |[多, 一些, 你, 每天, 愛]             |[多, 一些, 你, 每天, 愛]  |[-1.685991644859314,0.954159152507782,-0.021103744953870775]   |
|6mICNlckUVGuoK/XGC7bnxXf5s2ZnkpFHShaGL/zM2Y=|你是你的                         |[是, 你, 的]                         |[是, 你, 的]              |[-1.6389437119166055,0.9985449910163879,-0.05226113585134347]  |
|BUQwTuzZ8GKEiHtFoI1hFcKRK1W3EEpfD+VLcIVkUzQ=|Guilty All The Same (feat. Rakim)|[same, feat, all, guilti, the, rakim]|[feat, guilti, rakim]     |[-0.01765718807776769,-0.22774008909861246,-0.2740897585948308]|
|fuQO8mNakRgp0vDqDJbvorJvMcJMvSjldFKAz6g+27Y=|Steal My Girl                    |[my, steal, girl]                    |[steal, girl]             |[0.2736980468034744,-0.2423809915781021,-0.5914874970912933]   |
|oIkuw3YGuUhqJd8CMJxvBep4rEXXJxea71l1JO0EhfQ=|月亮惹的禍                       |[惹, 的, 月亮, 禍]                   |[惹, 的, 月亮, 禍]        |[-1.483116775751114,0.8222928494215012,-0.1712031066417694]    |
|jAeBPAOGuLjjF81uYHVj8sayYH6VQhaHGPhTfq+u8O4=|什麼東西                         |[什, 東, 麼, 西]                     |[什, 東, 麼, 西]          |[-1.5564243495464325,1.1126512438058853,-0.08804323803633451]  |
|gB4Fu5VOaGR+E1ITkBnb4yU2SdZFW6Q+K/OHPAZhZJk=|雨水我問你                       |[你, 我, 雨水, 問]                   |[你, 我, 雨水, 問]        |[-1.5947331190109253,0.8878207728266716,-0.06629252294078469]  |
|uzWI7xZfL3gL2/B4ptZs0XfBuGC20ydak01SjhFuEtc=|如此美麗的妳                     |[妳, 麗, 美, 如此, 的]               |[妳, 麗, 美, 如此, 的]    |[-1.4824027538299562,1.0099913001060485,-0.07599262148141861]  |
|EXBuTr6J7UY6MDozwT/UDRVnmW0VGRVfeGBzrxVlX3k=|老鷹之歌                         |[之, 老, 歌, 鷹]                     |[之, 老, 歌, 鷹]          |[-1.236002802848816,0.9920547306537628,0.15748962602810934]    |
|y2QmHXZMAhfVXwyQoimo5ZvMbNdS8qKCRRqKqU7izew=|離開                             |[開, 離]                             |[開, 離]                  |[-1.439205527305603,1.0693321228027344,-0.0031793825328350067] |
|isW4S3tqJo5Tce1AdM19n6TG53UQkBzyLFmb2QWK/G4=|Standing In The Rain             |[stand, the, in, rain]               |[stand, rain]             |[0.2646974101662636,-0.2759883850812912,-0.6130934953689575]   |
|OTKFDmheYsbqTCw2IEW4HDK3eckkrmXiQCWJWmgLSXI=|ONLY TIME (唯有時光)             |[光, time, 時, onli, 唯有]           |[光, time, 時, onli, 唯有]|[-0.429543536901474,0.4080437302589417,-0.34740326926112175]   |
+--------------------------------------------+-------------------------------------------------------------+-----------------------------------------------------------------+----------------------------------+

十一、msno，song_id，artist_name，composer和lyricist等高基数类别特征MeanEncoder编码。
	理由：高基数离散特征，如果采用one-hot将得到一个特别稀疏的矩阵，内存消耗过大。采用MeanEncoder可编码成K-1（K是应变量的类别数）列0到1的连续特征，对于二分类（K=2），一列就够，避免one-hot的稀疏。
	MeanEncoder计算方式：P = λP(y=target) + (1-λ)P(target=y|variable=k)，其中λ=1 / (1 + exp((n - k) / f)，n为样本数，k，f为超参数。

十二、使用ALS分解矩阵
	
十三、融合后的特征如下：
root(缺省值统一为-1)
 |-- user_id: int (nullable = true)	--用户id(已转成int类型唯一编码)
 |-- msno_predict_1: double (nullable = true)	--用户MeanEncode
 |-- item_id: int (nullable = true)	--歌曲id(已转成int类型唯一编码)
 |-- song_id_predict_1: double (nullable = true)	--歌曲MeanEncode
 |-- count: int (nullable = true)	--歌曲订阅量
 |-- source_system_tab: int (nullable = true)	--已转成int类型枚举编码
 |-- source_screen_name: int (nullable = true)	--已转成int类型枚举编码
 |-- source_type: int (nullable = true)	--已转成int类型枚举编码
 |-- target: int (nullable = true)
 |-- song_length: int (nullable = true)	--歌曲时长已取整为分钟
 |-- genre_ids: int (nullable = true)
 |-- artist_id: int (nullable = true)	--歌手id(已转成int类型唯一编码)
 |-- artist_name_predict_1: double (nullable = true)	--歌手MeanEncode
 |-- artist_rank: int (nullable = true)	--歌手热度(值为歌曲量)
 |-- composer_id: int (nullable = true)	--作曲id(已转成int类型唯一编码)
 |-- composer_predict_1: string (nullable = true)	--作曲MeanEncode
 |-- composer_rank: int (nullable = true)	--作曲热度(值为歌曲量)
 |-- lyricist_id: int (nullable = true)	--作词id(已转成int类型唯一编码)
 |-- lyricist_predict_1: string (nullable = true)	--作词MeanEncode
 |-- lyricist_rank: string (nullable = true)	--作词热度(值为歌曲量)
 |-- language: double (nullable = true)
 ......
 
+-----------------+------------------+-----------+------+-----------+---------+--------+---------------------+-----------+---------+------------------+-------------+-----------+------------------+-------------+-----------+-------------------+-------+-------------------+-----+-------+
|source_system_tab|source_screen_name|source_type|target|song_length|genre_ids|language|artist_name_predict_1|artist_rank|artist_id|composer_predict_1|composer_rank|composer_id|lyricist_predict_1|lyricist_rank|lyricist_id|     msno_predict_1|user_id|  song_id_predict_1|count|item_id|......
+-----------------+------------------+-----------+------+-----------+---------+--------+---------------------+-----------+---------+------------------+-------------+-----------+------------------+-------------+-----------+-------------------+-------+-------------------+-----+-------+
|                1|                10|          1|     0|          5|      465|     3.0|   0.4648481007892758|        169|     1767|0.5193699615858549|            2|     127383|0.5330456437967268|            2|      44397| 0.8341709074518411|  27702| 0.5035259743274101|    1| 193399|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.4116005752095999|           11|      32885|0.5564835586639216|            3|      32711|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.4116005752095999|           11|      32885|0.5564835586639216|           46|       1381|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.4116005752095999|           11|      32885|0.4243679259520203|            3|      32711|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.4116005752095999|           11|      32885|0.4243679259520203|           46|       1381|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.4116005752095999|           62|       3565|0.5564835586639216|            3|      32711|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.4116005752095999|           62|       3565|0.5564835586639216|           46|       1381|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.4116005752095999|           62|       3565|0.4243679259520203|            3|      32711|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.4116005752095999|           62|       3565|0.4243679259520203|           46|       1381|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.5722971732116442|           11|      32885|0.5564835586639216|            3|      32711|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|......
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.5722971732116442|           11|      32885|0.5564835586639216|           46|       1381|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.5722971732116442|           11|      32885|0.4243679259520203|            3|      32711|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.5722971732116442|           11|      32885|0.4243679259520203|           46|       1381|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.5722971732116442|           62|       3565|0.5564835586639216|            3|      32711|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.5722971732116442|           62|       3565|0.5564835586639216|           46|       1381|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.5722971732116442|           62|       3565|0.4243679259520203|            3|      32711|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     0|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.5722971732116442|           62|       3565|0.4243679259520203|           46|       1381|0.35545576617839814|  18379|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     1|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.4116005752095999|           11|      32885|0.5564835586639216|            3|      32711| 0.6963712638094691|  19492|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     1|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.4116005752095999|           11|      32885|0.5564835586639216|           46|       1381| 0.6963712638094691|  19492|0.43013203364170643|    6|  80455|
|                1|                -1|          1|     1|          5|      465|     3.0|   0.5250906212501131|        147|     2139|0.4116005752095999|           11|      32885|0.4243679259520203|            3|      32711| 0.6963712638094691|  19492|0.43013203364170643|    6|  80455|
+-----------------+------------------+-----------+------+-----------+---------+--------+---------------------+-----------+---------+------------------+-------------+-----------+------------------+-------------+-----------+-------------------+-------+-------------------+-----+-------+
